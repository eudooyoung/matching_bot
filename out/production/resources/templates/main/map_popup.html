<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>내 주변 채용 공고</title>
    <style>
        #map {
            width: 100%;
            height: 500px;
            margin-bottom: 10px;
        }
        #search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h2>내 주변 채용 공고</h2>

<div id="search-container">
    <input type="text" id="address-input" placeholder="주소나 장소명을 입력하세요" style="flex: 1;" />
    <button id="search-button">주소 검색</button>
</div>

<div id="map"></div>

<!-- ✅ Kakao Maps SDK -->
<script src="https://d.kakao.com/v2/maps/sdk.js?appkey=5387d38d345f44b99625ec93df1b8297&libraries=services"></script>

<script>
    let map;
    let searchMarker = null;
    let jobMarkers = [];
    let currentInfowindow = null;

    function initMap() {
        const DEFAULT_LAT = 35.170833;
        const DEFAULT_LNG = 129.130556;

        navigator.geolocation.getCurrentPosition(
            position => {
                loadMap(position.coords.latitude, position.coords.longitude);
            },
            error => {
                console.warn("❌ 위치 정보를 가져올 수 없어 기본 위치 사용:", error);
                alert("위치 정보를 가져올 수 없어 기본 위치로 지도를 표시합니다.");
                loadMap(DEFAULT_LAT, DEFAULT_LNG);
            }
        );
    }

    function clearJobMarkers() {
        jobMarkers.forEach(marker => marker.setMap(null));
        jobMarkers = [];
    }

    function loadMap(lat, lng) {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(lat, lng),
            level: 5
        };
        map = new kakao.maps.Map(container, options);

        // 내 위치 마커 (초록색)
        const myMarkerImage = new kakao.maps.MarkerImage(
            'http://t1.daumcdn.net/localimg/localimages/07/mapdoc/markerStar.png',
            new kakao.maps.Size(24, 35)
        );
        const myMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(lat, lng),
            image: myMarkerImage
        });

        clearJobMarkers();

        fetch(`//jobs/nearby?lat=${lat}&lng=${lng}`)
            .then(res => res.json())
            .then(jobs => {
                jobs.forEach(job => {
                    if (job.latitude && job.longitude) {
                        const coords = new kakao.maps.LatLng(job.latitude, job.longitude);

                        // 채용공고 마커 (기본 붉은색 마커)
                        const jobMarker = new kakao.maps.Marker({
                            map,
                            position: coords
                        });
                        jobMarkers.push(jobMarker);

                        const content = `
  <div style="padding:5px; font-size:14px;">
    <strong>회사명: ${job.companyName || "미정"}</strong><br/>
    직무: ${job.title}<br/>
    언어: ${job.requiredSkills || "정보 없음"}<br/>
    연봉: ${job.salary || "협의"}<br/>
    <button onclick="window.location.href='/jobs/${job.id}'"
            style="margin-top:5px; padding:3px 6px; font-size:13px;">
      상세보기
    </button>
  </div>
`;


                        const infowindow = new kakao.maps.InfoWindow({ content });

                        kakao.maps.event.addListener(jobMarker, 'click', () => {
                            if (currentInfowindow) currentInfowindow.close();
                            currentInfowindow = infowindow;
                            infowindow.open(map, jobMarker);
                        });
                    }
                });
            })
            .catch(err => console.error("❌ 채용공고 마커 오류:", err));
    }

    function searchAddress() {
        const query = document.getElementById('address-input').value.trim();
        if (!query) {
            alert("검색어를 입력하세요.");
            return;
        }

        const ps = new kakao.maps.services.Places();

        ps.keywordSearch(query, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                map.setCenter(coords);

                // 기존 검색 마커 제거
                if (searchMarker) searchMarker.setMap(null);

                // 새 검색 마커 추가
                searchMarker = new kakao.maps.Marker({ map, position: coords });

                // ✅ 검색된 좌표 기준으로 채용공고 마커 다시 로드
                loadMap(result[0].y, result[0].x);
            } else {
                alert("장소를 찾을 수 없습니다.");
            }
        });
    }

    window.onload = function () {
        initMap();

        const input = document.getElementById("address-input");
        const button = document.getElementById("search-button");

        input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                searchAddress();
            }
        });

        button.addEventListener("click", function () {
            searchAddress();
        });
    };
</script>


</body>
</html>
