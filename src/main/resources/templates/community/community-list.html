<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>MatchingBot | 커뮤니티</title>

  <!-- ✅ Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- ✅ 공통 CSS -->
  <link rel="stylesheet" th:href="@{/css/layout.css}"/>

  <style>
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: bold;
    }

    .card-text {
      font-size: 1rem;
      color: #555;
    }

    .author-text {
      font-size: 0.9rem;
      color: #888;
    }

  </style>
</head>
<body>
<div class="wrapper">
  <!-- ✅ Header Fragment -->
  <div th:replace="~{fragments/header :: header(role=${role})}"></div>

  <main class="main-content container py-5">
    <h2 class="text-center mb-4">커뮤니티 게시글 목록</h2>

    <!-- ✅ 카테고리 필터 -->
    <option th:each="category : ${categories}"
            th:value="${category.id}"
            th:selected="${category.id == param.categoryId}"
            th:text="${category.name}">
    </option>

        <form method="get" action="/community/list" class="text-center mb-4">
      <select name="categoryId" class="form-select w-auto d-inline-block me-2">
        <option value="">전체</option>
        <option th:each="category : ${categories}"
                th:value="${category.id}"
                th:text="${category.name}"></option>
      </select>
      <button type="submit" class="btn btn-outline-primary">검색</button>
    </form>

    <!-- ✅ 게시글 목록 -->
    <div class="row">
      <div class="col-md-4" th:each="post : ${postList}">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">
              <a th:href="@{'/community/detail/' + ${post.id}}" th:text="${post.title}">제목</a>
            </h5>
            <p class="card-text" th:text="${post.content}">내용 미리보기</p>
            <p class="author-text"><strong>작성자:</strong> <span th:text="${post.writerName}">작성자</span></p>
          </div>
        </div>
      </div>
    </div>
    <!-- ✅ 페이징 처리 -->
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${postPage.first} ? 'disabled'">
          <a class="page-link"
             th:href="@{/community/list(page=${postPage.number - 1}, categoryId=${param.categoryId})}">이전</a>
        </li>

        <li class="page-item" th:each="i : ${#numbers.sequence(0, postPage.totalPages - 1)}"
            th:classappend="${postPage.number == i} ? 'active'">
          <a class="page-link"
             th:href="@{/community/list(page=${i}, categoryId=${param.categoryId})}"
             th:text="${i + 1}">1</a>
        </li>

        <li class="page-item" th:classappend="${postPage.last} ? 'disabled'">
          <a class="page-link"
             th:href="@{/community/list(page=${postPage.number + 1}, categoryId=${param.categoryId})}">다음</a>
        </li>
      </ul>
    </nav>

    <!-- ✅ 글쓰기 버튼 -->
    <!-- ✍ 로그인한 사용자만 보이는 글쓰기 버튼 -->
    <div class="text-end mt-4" sec:authorize="isAuthenticated()">
      <a th:href="@{/community/write}" class="btn btn-primary">✍ 글쓰기</a>
    </div>


    <script>
      document.getElementById("write-button").addEventListener("click", function () {
        const isAuthenticated = /*[[${#authentication.authenticated}]]*/ false; // Thymeleaf에서 로그인 여부 주입

        if (!isAuthenticated) {
          const confirmLogin = confirm("로그인이 필요합니다.\n로그인하시겠습니까?");
          if (confirmLogin) {
            window.location.href = "/auth/login"; // 로그인 페이지 경로
          } else {
            // 아무 행동 안 하면 그대로 게시글 리스트 유지됨
          }
        } else {
          // 로그인 상태일 경우 글쓰기 페이지로 이동
          window.location.href = "/community/write";
        }
      });
    </script>
  </main>

  <!-- ✅ Footer Fragment -->
  <div th:insert="~{fragments/footer :: footer}"></div>
</div>

<!-- ✅ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ✅ JS 스크립트 -->
<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>
</body>
</html>
