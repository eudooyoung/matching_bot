<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>내 주변 채용 공고</title>
    <style>
        #map {
            width: 100%;
            height: 500px;
            margin-bottom: 10px;
        }
        #search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h2>내 주변 채용 공고</h2>

<div id="search-container">
    <input type="text" id="address-input" placeholder="주소나 장소명을 입력하세요" style="flex: 1;" />
    <button id="search-button">주소 검색</button>
</div>

<div id="map"></div>

<!-- ✅ Kakao Maps SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5387d38d345f44b99625ec93df1b8297&libraries=services"></script>

<script>
    let map;
    let searchMarker = null;
    let jobMarkers = [];
    let currentInfowindow = null;

    function initMap() {
        const DEFAULT_LAT = 37.554722;
        const DEFAULT_LNG = 126.970833;

        navigator.geolocation.getCurrentPosition(
            position => {
                console.log("✅ 위치 좌표:", position.coords);
                loadMap(position.coords.latitude, position.coords.longitude);
            },
            error => {
                console.warn("❌ 위치 정보를 가져올 수 없어 기본 위치 사용:", error);
                alert("위치 정보를 가져올 수 없어 기본 위치로 지도를 표시합니다.");
                loadMap(DEFAULT_LAT, DEFAULT_LNG);
            }
        );
    }

    function clearJobMarkers() {
        jobMarkers.forEach(marker => marker.setMap(null));
        jobMarkers = [];
    }

    function loadMap(lat, lng) {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(lat, lng),
            level: 5
        };
        map = new kakao.maps.Map(container, options);

        const myPos = new kakao.maps.LatLng(lat, lng);
        const myMarker = new kakao.maps.Marker({
            map: map,
            position: myPos
        });
        console.log("✅ 내 위치 마커 생성됨:", myMarker);

        // 기존 마커들 제거
        clearJobMarkers();

        fetch(`/api/jobs/nearby?lat=${lat}&lng=${lng}`)
            .then(res => res.json())
            .then(jobs => {
                const geocoder = new kakao.maps.services.Geocoder();
                jobs.forEach(job => {
                    geocoder.addressSearch(job.address, function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            const marker = new kakao.maps.Marker({ map, position: coords });
                            jobMarkers.push(marker);

                            const content = `
                                <div style="padding:5px;">
                                  <strong>${job.companyName}</strong><br/>
                                  ${job.title}<br/>
                                  마감일: ${job.deadline}
                                </div>
                            `;
                            const infowindow = new kakao.maps.InfoWindow({ content });

                            kakao.maps.event.addListener(marker, 'click', () => {
                                if (currentInfowindow) currentInfowindow.close();
                                currentInfowindow = infowindow;
                                infowindow.open(map, marker);
                            });
                        }
                    });
                });
            })
            .catch(err => console.error("❌ 채용공고 마커 오류:", err));
    }

    function searchAddress() {
        const query = document.getElementById('address-input').value.trim();
        if (!query) {
            alert("검색어를 입력하세요.");
            return;
        }

        const ps = new kakao.maps.services.Places();

        ps.keywordSearch(query, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                map.setCenter(coords);

                // 기존 검색 마커 제거
                if (searchMarker) searchMarker.setMap(null);

                // 새 검색 마커 추가
                searchMarker = new kakao.maps.Marker({ map, position: coords });
            } else {
                alert("장소를 찾을 수 없습니다.");
            }
        });
    }

    window.onload = function () {
        initMap();

        const input = document.getElementById("address-input");
        const button = document.getElementById("search-button");

        input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                searchAddress();
            }
        });

        button.addEventListener("click", function () {
            searchAddress();
        });
    };
</script>

</body>
</html>
