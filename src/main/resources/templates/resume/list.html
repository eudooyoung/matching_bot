<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>MatchingBot | ì´ë ¥ì„œ ëª©ë¡</title>

  <!-- âœ… Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/layout.css}"/>

  <style>
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .card-text {
      font-size: 1rem;
      color: #555;
    }

    .meta-text {
      font-size: 0.9rem;
      color: #777;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div th:replace="~{fragments/header :: header(role=${role})}"></div>

  <main class="main-content container py-5">
    <h2 class="text-center mb-4">ì§€ì›ì ì´ë ¥ì„œ ëª©ë¡</h2>


    <!-- âœ… ê²€ìƒ‰ ì…ë ¥ -->
    <section class="text-center mb-4">
      <input type="text" id="resume-search-input" placeholder="ì´ë ¥ì„œ ì œëª© ë˜ëŠ” ê¸°ìˆ  ê²€ìƒ‰" class="form-control d-inline-block w-50"/>
      <button type="button" id="resume-search-button" class="btn btn-primary ms-2">ğŸ” ê²€ìƒ‰</button>
    </section>

    <!-- âœ… ì´ë ¥ì„œ ì¹´ë“œ ëª©ë¡ -->
    <div class="row">
      <div class="col-md-4" th:each="resume : ${resumeList}">
        <div class="card h-100 resume-card" th:onclick="|location.href='@{/resumes/{id}(id=${resume.id})}'|"
             style="cursor: pointer;">
          <div class="card-body">
            <div class="resume-card-header">
              <h5 class="card-title" th:text="${resume.memberName} ?: 'ì´ë¦„ ì—†ìŒ'">ì§€ì›ì ì´ë¦„</h5>
              <button
                      class="star-button"
                      th:classappend="${resume.bookmarked} ? 'filled' : ''"
                      onclick="toggleStar(this, [[${resume.id}]], event)"
                      sec:authorize="hasRole('COMPANY')">
                <span th:text="${resume.bookmarked} ? 'â˜…' : 'â˜†'">â˜†</span>
              </button>
            </div>
            <p class="card-text"><strong>ì´ë ¥ì„œ ì œëª©:</strong> <span th:text="${resume.title} ?: 'ì œëª© ì—†ìŒ'"></span></p>
            <p class="card-text"><strong>ê¸°ìˆ  ì†Œê°œ:</strong> <span th:text="${resume.skillAnswer} ?: 'ê¸°ìˆ  ì†Œê°œ ì—†ìŒ'"></span></p>
            <p class="card-text"><strong>ì„±í–¥ ì†Œê°œ:</strong> <span th:text="${resume.traitAnswer} ?: 'ì„±í–¥ ì†Œê°œ ì—†ìŒ'"></span></p>
            <p class="card-text"><strong>ê¸°ìˆ  í‚¤ì›Œë“œ:</strong> <span th:text="${resume.skillKeywords} ?: 'ê¸°ìˆ  í‚¤ì›Œë“œ ì—†ìŒ'"></span></p>
            <p class="card-text"><strong>ì‘ì„±ì¼:</strong> <span th:text="${#temporals.format(resume.createdAt, 'yyyy-MM-dd')} ?: 'ì‘ì„±ì¼ ì—†ìŒ'"></span></p>
          </div>
        </div>
      </div>
    </div>


    <!-- âœ… í˜ì´ì§• ì˜ì—­ -->
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
          <a class="page-link" th:href="@{'/resumes?page=' + (${currentPage - 1})}">ì´ì „</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
            th:classappend="${currentPage == i} ? 'active'">
          <a class="page-link" th:href="@{'/resumes?page=' + ${i}}" th:text="${i}">1</a>
        </li>
        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
          <a class="page-link" th:href="@{'/resumes?page=' + (${currentPage + 1})}">ë‹¤ìŒ</a>
        </li>
      </ul>
    </nav>



    <!-- âœ… ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      window.onload = function () {
        const mapBtn = document.getElementById("openMapButton");
        if (mapBtn) {
          mapBtn.addEventListener("click", function () {
            window.open('/map_popup', 'mapPopup', 'width=800,height=600');
          });
        }

        const searchInput = document.getElementById("search-input");
        const filterSection = document.getElementById("search-filters");
        searchInput.addEventListener("focus", () => {
          filterSection.style.display = "block";
        });

        document.getElementById("search-button").addEventListener("click", () => {
          const jobGroup = document.getElementById("filter-job-group").value;
          const jobType = document.getElementById("filter-job-type").value;
          const jobRole = document.getElementById("filter-job-role").value;
          const regionMain = document.getElementById("filter-region-main").value;
          const regionSub = document.getElementById("filter-region-sub").value;

          const query = new URLSearchParams({
            regionMain: regionMain || '',
            regionSub: regionSub || '',
            jobGroup: jobGroup || '',
            jobType: jobType || '',
            jobRole: jobRole || ''
          }).toString();

          window.location.href = `/search-page?${query}`;
        });
      };
    </script>

    <!-- React Selector ëª¨ë“ˆ -->
    <script th:src="@{/js/dropdown.js}"></script>
    <script th:src="@{/js/logout.js}"></script>
    <script type="module">
      import React from "https://cdn.jsdelivr.net/npm/react@18.2.0/+esm";
      import {createRoot} from "https://cdn.jsdelivr.net/npm/react-dom@18.2.0/client/+esm";

      window.React = React;
      window.createRoot = createRoot;
    </script>
  </main>

  <div th:insert="~{fragments/footer :: footer}"></div>
</div>

<script>
  function toggleStar(button, resumeId, event) {
    event.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¤‘ë‹¨

    const isBookmarked = button.classList.contains('filled');
    const method = isBookmarked ? 'DELETE' : 'POST';
    const companyId = window.loggedInCompanyId;

    fetch(`/job/resume-bookmark/${resumeId}/company/${companyId}`, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': getCsrfToken()
      }
    })
            .then(response => {
              if (response.ok) {
                button.classList.toggle('filled');
                button.textContent = button.classList.contains('filled') ? 'â˜…' : 'â˜†';
              } else {
                alert('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            })
            .catch(() => {
              alert('ì„œë²„ í†µì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
  }
</script>


<script th:src="@{/js/logout.js}"></script>

</body>
</html>
