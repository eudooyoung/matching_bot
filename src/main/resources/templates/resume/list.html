<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>MatchingBot | 이력서 목록</title>

  <!-- ✅ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" th:href="@{/css/layout.css}"/>

  <style>
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .card-text {
      font-size: 1rem;
      color: #555;
    }

    .meta-text {
      font-size: 0.9rem;
      color: #777;
    }
  </style>

  <!-- head 안에 직접 삽입하여 JS inline으로 실행해 보기 -->
  <script type="module">
    import React from "https://cdn.jsdelivr.net/npm/react@18.2.0/+esm";
    import { createRoot } from "https://cdn.jsdelivr.net/npm/react-dom@18.2.0/client/+esm";

    function CareerTypeSelector() {
      const [careerType, setCareerType] = React.useState('');

      const handleChange = (e) => {
        const value = e.target.value;
        setCareerType(value);
        document.getElementById('filter-career-type').value = value;
      };

      const container = document.getElementById('react-career-type-selector');
      if (container) {
        const root = createRoot(container);
        root.render(
                <div className="career-type-selector">
                  <label className="me-3">
                    <input type="radio" name="careerType" value="" onChange={handleChange} checked={careerType === ''}/> 전체
                  </label>
                  <label className="me-3">
                    <input type="radio" name="careerType" value="new" onChange={handleChange} checked={careerType === 'new'}/> 신입
                  </label>
                  <label>
                    <input type="radio" name="careerType" value="exp" onChange={handleChange} checked={careerType === 'exp'}/> 경력
                  </label>
                </div>
        );
      }
    }

    CareerTypeSelector();
  </script>

</head>
<body>

<div class="wrapper">
  <div th:replace="~{fragments/header :: header(role=${role})}"></div>

  <main class="main-content container py-5">
    <h2 class="text-center mb-4">지원자 이력서 목록</h2>

    <!-- ✅ 검색창 -->
    <section class="text-center mb-4">
      <input type="text" id="search-input" placeholder="이력서 검색" class="form-control d-inline-block w-50"/>
      <button type="button" id="search-button" class="btn btn-primary ms-2">🔍 검색</button>
    </section>

    <!-- ✅ 신입/경력 필터 영역 -->
    <section id="search-filters" class="text-center mb-4" style="display: none;">
      <label><strong>경력 유형:</strong></label>
      <div id="react-career-type-selector" class="my-2 d-inline-block"></div>
      <input type="hidden" id="filter-career-type" />
    </section>

    <!-- ✅ 이력서 카드 목록 -->
    <div class="row">
      <div class="col-md-4" th:each="resume : ${resumeList}">
        <div class="card h-100 resume-card" th:onclick="|location.href='@{/resumes/{id}(id=${resume.id})}'|" style="cursor: pointer;">
          <div class="card-body">
            <div class="resume-card-header">
              <h5 class="card-title" th:text="${resume.memberName} ?: '이름 없음'">지원자 이름</h5>
              <button
                      class="star-button"
                      th:classappend="${resume.bookmarked} ? 'filled' : ''"
                      th:data-resume-id="${resume.id}"
                      onclick="toggleStar(this, event)"
                      sec:authorize="hasRole('COMPANY')">
                <span th:text="${resume.bookmarked} ? '★' : '☆'">☆</span>
              </button>
            </div>
            <p class="card-text"><strong>이력서 제목:</strong> <span th:text="${resume.title} ?: '제목 없음'"></span></p>
            <p class="card-text"><strong>기술 소개:</strong> <span th:text="${resume.skillAnswer} ?: '기술 소개 없음'"></span></p>
            <p class="card-text"><strong>성향 소개:</strong> <span th:text="${resume.traitAnswer} ?: '성향 소개 없음'"></span></p>
            <p class="card-text"><strong>기술 키워드:</strong> <span th:text="${resume.skillKeywords} ?: '기술 키워드 없음'"></span></p>
            <p class="card-text"><strong>작성일:</strong> <span th:text="${#temporals.format(resume.createdAt, 'yyyy-MM-dd')} ?: '작성일 없음'"></span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ 페이징 -->
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
          <a class="page-link" th:href="@{'/resumes?page=' + (${currentPage - 1})}">이전</a>
        </li>
        <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}" th:classappend="${currentPage == i} ? 'active'">
          <a class="page-link" th:href="@{'/resumes?page=' + ${i}}" th:text="${i}">1</a>
        </li>
        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
          <a class="page-link" th:href="@{'/resumes?page=' + (${currentPage + 1})}">다음</a>
        </li>
      </ul>
    </nav>

  </main>

  <div th:insert="~{fragments/footer :: footer}"></div>
</div>

<!-- ✅ 검색 스크립트 -->
<!--<script>-->
<!--  window.onload = function () {-->
<!--    const searchInput = document.getElementById("search-input");-->
<!--    const filterSection = document.getElementById("search-filters");-->
<!--    if (searchInput && filterSection) {-->
<!--      searchInput.addEventListener("focus", () => {-->
<!--        filterSection.style.display = "block";-->
<!--      });-->
<!--    }-->


<!--    document.getElementById("search-button").addEventListener("click", () => {-->
<!--      const companyName = document.getElementById("search-input").value;-->
<!--      const jobGroup = document.getElementById("filter-job-group").value;-->
<!--      const jobType = document.getElementById("filter-job-type").value;-->
<!--      const jobRole = document.getElementById("filter-job-role").value;-->
<!--      const regionMain = document.getElementById("filter-region-main").value;-->
<!--      const regionSub = document.getElementById("filter-region-sub").value;-->

<!--      const query = new URLSearchParams({-->
<!--        companyName: companyName || '',-->
<!--        regionMain: regionMain || '',-->
<!--        regionSub: regionSub || '',-->
<!--        jobGroup: jobGroup || '',-->
<!--        jobType: jobType || '',-->
<!--        jobRole: jobRole || ''-->
<!--      }).toString();-->

<!--      window.location.href = `/search-page?${query}`;-->
<!--    });-->
<!--  };-->
<!--</script>-->

<!-- ✅ React 모듈 -->
<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>

<!-- ✅ React 설정 -->
<script type="module">
  import React from "https://cdn.jsdelivr.net/npm/react@18.2.0/+esm";
  import {createRoot} from "https://cdn.jsdelivr.net/npm/react-dom@18.2.0/client/+esm";

  window.React = React;
  window.createRoot = createRoot;
</script>

<!-- ✅ 경력 필터 React 컴포넌트 -->
<script type="module" src="/js/JobCategorySelector.js"></script>
<!--<script type="module" src="/js/CareerTypeSelector.js"></script>-->
      window.React = React;
      window.createRoot = createRoot;
<!--    </script>-->
<!--  </main>-->

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- 이력서 즐겨찾기 -->
<script>
  function toggleStar(button, event) {
    event.stopPropagation();
    const resumeId = button.dataset.resumeId;

    fetch(`/job/resume-bookmark/toggle?resumeId=${resumeId}`, {
      method: 'POST'
    })
            .then(response => {
              if (!response.ok) throw new Error("즐겨찾기 실패");
              return response.json();
            })
            .then(data => {
              const icon = button.querySelector('span');

              if (data.bookmarked) {
                button.classList.add('filled');
                icon.textContent = '★';
                alert('이력서가 즐겨찾기 되었습니다.');
              } else {
                button.classList.remove('filled');
                icon.textContent = '☆';
                alert('즐겨찾기가 해제되었습니다.');
              }
            })
            .catch(error => {
              console.error(error);
              alert('오류가 발생했습니다.');
            });
  }

</script>

<script th:src="@{/js/logout.js}"></script>

</body>
</html>
