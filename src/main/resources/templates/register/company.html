<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>기업 회원가입</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/spinner-chatbot.css}">
    <link rel="stylesheet" th:href="@{/css/register.css}" >
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="wrapper">
    <div th:replace="~{fragments/header :: header(role=${role})}"></div>

    <div id="loadingOverlay" class="overlay" style="display: none;">
        <div class="spinner"></div>
        <p>
            AI가 기업 정보를 분석하고 있습니다.<br>
            잠시만 기다려 주세요...
        </p>
    </div>

    <main class="main-content">
        <div class="container">
            <h2>기업 회원가입</h2>

            <!-- 에러 메시지 -->
            <div th:if="${error}" class="error-message">
                <p th:text="${error}">회원가입 중 오류가 발생했습니다.</p>
            </div>

            <form id="companyForm" action="/auth/register-company" method="post">
                <!-- 이메일 -->
                <label for="email">* 이메일</label>
                <input type="email" id="email" name="email" placeholder="email@matchingbot.co.kr" required>

                <!-- 비밀번호 -->
                <label for="password">* 비밀번호</label>
                <input type="password" id="password" name="password"
                       placeholder="8~16자 / 영문, 숫자, 특수문자 조합"
                       required minlength="8" maxlength="16">

                <!-- 회사명 -->
                <label for="name">* 회사명</label>
                <input type="text" id="name" name="name" placeholder="회사명을 입력해주세요" required minlength="2"
                       maxlength="30">

                <!-- 사업자등록번호 -->
                <label for="businessNo">* 사업자등록번호</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="businessNo" name="businessNo" required>
                    <button type="button" onclick="businessNumber()">인증</button>
                </div>
                <div id="regimessage" class="helper-text" style="color: green;"></div>

                <!-- 주소 -->
                <label for="address">* 주소</label>
                <input type="text" id="address" name="address" required maxlength="50">

                <!-- 산업군 -->
                <label for="industry">* 산업군</label>
                <input type="text" id="industry" name="industry" required maxlength="20">

                <!-- 설립일 -->
                <label>* 설립일</label>
                <div class="birth-gender">
                    <select name="establishedYear" id="establishedYear" required></select>
                    <select name="establishedMonth" id="establishedMonth" required></select>
                    <select name="establishedDay" id="establishedDay" required></select>
                </div>

                <!-- 직원수 -->
                <label for="headcount">* 직원수</label>
                <input type="text" id="headcount" name="headcount">

                <!-- 연매출 -->
                <label for="annualRevenue">* 연매출 (억)</label>
                <input type="text" id="annualRevenue" name="annualRevenue">

                <!-- 영업이익 -->
                <label for="operatingIncome">* 영업이익 (억원)</label>
                <input type="text" id="operatingIncome" name="operatingIncome">

                <!-- 최근 1년 채용공고 수 -->
                <label for="jobsLastYear">* 최근 1년 채용공고 수</label>
                <input type="text" id="jobsLastYear" name="jobsLastYear">

                <!-- 약관 동의 -->
                <div class="agreement-box">
                    <div class="agreement-title">* 약관 동의</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="agree_all">
                            <span>전체 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeTerms" value="Y" required>
                            <span>[필수] 서비스 이용약관 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreePrivacy" value="Y" required>
                            <span>[필수] 정보 수집 및 이용 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeFinance" value="Y" required>
                            <span>[필수] 정보 제공 동의 (OPEN API 포함)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeMarketing" value="Y">
                            <span>[선택] 마케팅 정보 수신 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeThirdParty" value="Y">
                            <span>[선택] 제3자 정보 제공 동의</span>
                        </label>
                    </div>
                </div>

                <button type="submit">다음으로</button>
            </form>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<!--<script>
    const currentYear = new Date().getFullYear();

    const establishedYearEl = document.getElementById("establishedYear");
    for (let i = currentYear; i >= 1900; i&#45;&#45;) {
        establishedYearEl.innerHTML += `<option value="${i}">${i}년</option>`;
    }

    const establishedMonthEl = document.getElementById("establishedMonth");
    for (let i = 1; i <= 12; i++) {
        establishedMonthEl.innerHTML += `<option value="${i}">${i}월</option>`;
    }

    const establishedDayEl = document.getElementById("establishedDay");
    for (let i = 1; i <= 31; i++) {
        establishedDayEl.innerHTML += `<option value="${i}">${i}일</option>`;
    }
</script>
<script>
    document.querySelector("input[name='agree_all']").addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll(".checkbox-group input[type='checkbox']")
            .forEach(chk => {
                if (chk !== this) chk.checked = checked;
            });
    });

    // 비밀번호 유효성 검사 함수
    function validatePassword(password) {
        const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+=-]).{8,16}$/;
        return regex.test(password);
    }

    //  인증 버튼 클릭 시 사업자 번호 검증 결과만 표시
    function businessNumber() {
        let num = document.getElementById('businessNo').value;

        if (num === '1234567890') {
            document.getElementById('regimessage').innerHTML = "<br>사업자 회원가입이 가능합니다. (테스트)";
            return;
        }

        const data = {"b_no": [num]};
        $.ajax({
            url: "/api/validate-business",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "JSON",
            contentType: "application/json",
            success: function (result) {
                let valid = result.data[0]['b_stt_cd'];
                let msg = document.getElementById('regimessage');
                msg.innerHTML = valid === '01'
                    ? "<br>사업자 회원가입이 가능합니다."
                    : "<br>사업자 회원가입을 할 수 없습니다.";
            },
            error: function (err) {
                console.log(err.responseText);
            }
        });
    }

    // form 제출 이벤트 리스너 등록
    document.getElementById("companyForm").addEventListener("submit", function (e) {
        e.preventDefault(); // 기본 제출 막기

        const form = this;
        const password = document.getElementById("password").value;

        if (!validatePassword(password)) {
            alert("비밀번호는 8~16자이며, 영문자/숫자/특수문자를 모두 포함해야 합니다.");
            document.getElementById("password").focus();
            return;
        }

        if (!form.checkValidity()) {
            form.reportValidity(); // 브라우저 유효성 경고
            return;
        }

        businessRegi(); // 사업자 인증 → 성공 시 수동 submit
    });

    //  사업자 인증 후 제출 로직
    function businessRegi() {
        const form = document.getElementById("companyForm");

        //  폼 유효성 최종 체크
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        let num = document.getElementById('businessNo').value;

        // TODO: 배포시 주석 혹은 삭제
        if (num === '1234567890') {
            alert("사업자 인증에 성공했습니다. (테스트)");
            // form.submit();
            showLoadingAndSubmit(form);
            return;
        }

        const data = {"b_no": [num]};
        $.ajax({
            url: "/api/validate-business",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "JSON",
            contentType: "application/json",
            success: function (result) {
                let valid = result.data[0]['b_stt_cd'];
                if (valid === '01') {
                    alert("사업자 인증에 성공했습니다.");
                    if (form.checkVisibility()) {

                        // form.submit();
                        // TODO: 배포시 활성화
                        /*if (form.checkVisibility()) {
                            showLoadingAndSubmit(form);
                        }*/
                    } else {
                        form.reportValidity();
                    }
                } else {
                    alert("사업자가 아닙니다.");
                }
            },
            error: function () {
                alert("인증 처리 중 에러 발생");
            }
        });
    }
</script>-->
<script>
    function showLoadingAndSubmit(form) {
        document.getElementById("loadingOverlay").style.display = "flex";
        form.submit();
    }
</script>
<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>
<script th:src="@{/js/register/company-functions.js}"></script>
</body>
</html>