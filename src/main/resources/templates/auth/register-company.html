<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>기업 회원가입</title>
    <link rel="stylesheet" type="text/css" href="/css/register.css">
    <link rel="stylesheet" th:href="@{/css/layout.css}" href="/css/layout.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<style>
    .agreement-box {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        background-color: #fafafa;
        margin-top: 24px;
        font-size: 14px;
        max-width: 600px;
    }


    .agreement-title {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.4;
        font-size: 14px;
        padding: 4px 0;
    }

    .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        margin: 0;
        vertical-align: middle;
    }

    .checkbox-item span {
        display: inline-block;
        line-height: 1.3;
        flex: 1;
        word-break: break-word;
        padding-left: 4px;
    }

    .agree-all-note {
        font-size: 12px;
        color: #666;
        margin-left: 28px;
        margin-top: -6px;
        margin-bottom: 10px;
    }
</style>
<style>
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6); /* 어두운 배경 */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
        color: #fff;
        font-family: 'Pretendard', sans-serif;
        font-size: 18px;
        font-weight: 500;
        letter-spacing: 0.2px;
        animation: fadeIn 0.3s ease-in-out;
    }

    .spinner {
        border: 6px solid rgba(255, 255, 255, 0.2);
        border-top: 6px solid #ffffff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 18px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
</style>

<body>

<div class="wrapper">
    <div th:replace="fragments/header :: header(role=${role})"></div>

    <div id="loadingOverlay" class="overlay" style="display: none;">
        <div class="spinner"></div>
        <p>
            AI가 기업 정보를 분석하고 있습니다.<br>
            잠시만 기다려 주세요...
        </p>
    </div>

    <main class="main-content">
        <div class="container">
            <h2>기업 회원가입</h2>

            <div th:if="${error}" class="error">
                <p th:text="${error}"></p>
            </div>

            <form id="companyForm" action="/auth/register-company" method="post">
                <!-- 1. 기본 정보 입력 -->
                <div>
                    <label for="email">* 이메일</label>
                    <input type="email" id="email" name="email" placeholder="email@matchingbot.co.kr" required>
                    <br>

                    <label for="password">* PW </label>
                    <input type="password"
                           id="password"
                           name="password"
                           placeholder="8~16자 / 영문, 숫자, 특수문자 조합"
                           required
                           minlength="8"
                           maxlength="16">
                    <br>

                    <label>* 회사명</label>
                    <input type="text"
                           id="name"
                           name="name"
                           placeholder="회사명을 입력해주세요"
                           required
                           minlength="2"
                           maxlength="30">
                    <br>
                </div>

                <!-- 2. 사업자등록번호 -->
                <div>
                    <label>* 사업자등록번호</label><br>
                    <input type="text" id="businessNo" name="businessNo" required>
                    <button type="button" onclick="businessNumber()">인증</button>
                    <div id="regimessage" style="color: green;"></div>
                </div>

                <!-- 3. 주소 -->
                <label for="address">* 주소</label>
                <input type="text" id="address" name="address" required maxlength="50">
                <br>

                <label>* 산업군</label><br>
                <input type="text" name="industry" required maxlength="20"><br>

                <!-- 5. 추가 기업 정보 -->
                <div>
                    <label>* 설립일</label>
                    <div class="birth-gender">
                        <select name="establishedYear" id="establishedYear" required></select>
                        <select name="establishedMonth" id="establishedMonth" required></select>
                        <select name="establishedDay" id="establishedDay" required></select>
                    </div>

                    <script>
                        const currentYear = new Date().getFullYear();

                        const establishedYearEl = document.getElementById("establishedYear");
                        for (let i = currentYear; i >= 1900; i--) {
                            establishedYearEl.innerHTML += `<option value="${i}">${i}년</option>`;
                        }

                        const establishedMonthEl = document.getElementById("establishedMonth");
                        for (let i = 1; i <= 12; i++) {
                            establishedMonthEl.innerHTML += `<option value="${i}">${i}월</option>`;
                        }

                        const establishedDayEl = document.getElementById("establishedDay");
                        for (let i = 1; i <= 31; i++) {
                            establishedDayEl.innerHTML += `<option value="${i}">${i}일</option>`;
                        }
                    </script>

                    <label>* 직원수</label><br>
                    <input type="text" name="headcount"><br>

                    <label>* 연매출 (원)</label><br>
                    <input type="text" name="annualRevenue"><br>

                    <label>* 영업이익 (원)</label><br>
                    <input type="text" name="operatingIncome"><br>

                    <label>* 최근 1년 채용공고 수</label><br>
                    <input type="text" name="jobsLastYear"><br>
                </div>


                <div class="agreement-box">
                    <div class="agreement-title">* 약관동의</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="agree_all">
                            <span>전체 동의</span>
                        </label>

                        <!-- 필수 항목 -->
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeTerms" value="Y" required>
                            <span>[필수] 서비스 이용약관 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreePrivacy" value="Y" required>
                            <span>[필수] 정보 수집 및 이용 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeFinance" value="Y" required>
                            <span>[필수] 정보 제공 동의 (OPEN API 포함)</span>
                        </label>

                        <!-- 선택 항목 -->
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeMarketing" value="Y">
                            <span>[선택] 마케팅 정보 수신 동의</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="agreeThirdParty" value="Y">
                            <span>[선택] 제3자 정보 제공 동의</span>
                        </label>
                    </div>
                </div>

                <!--  수정된 버튼 -->
                <button type="submit">다음으로</button>
            </form>
        </div>
    </main>

    <!-- 공통 푸터 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script>
    document.querySelector("input[name='agree_all']").addEventListener('change', function () {
        const checked = this.checked;
        document.querySelectorAll(".checkbox-group input[type='checkbox']")
            .forEach(chk => {
                if (chk !== this) chk.checked = checked;
            });
    });

    // 비밀번호 유효성 검사 함수
    function validatePassword(password) {
        const regex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*()_+=-]).{8,16}$/;
        return regex.test(password);
    }

    //  인증 버튼 클릭 시 사업자 번호 검증 결과만 표시
    function businessNumber() {
        let num = document.getElementById('businessNo').value;

        if (num === '1234567890') {
            document.getElementById('regimessage').innerHTML = "<br>사업자 회원가입이 가능합니다. (테스트)";
            return;
        }

        const data = {"b_no": [num]};
        $.ajax({
            url: "/api/validate-business",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "JSON",
            contentType: "application/json",
            success: function (result) {
                let valid = result.data[0]['b_stt_cd'];
                let msg = document.getElementById('regimessage');
                msg.innerHTML = valid === '01'
                    ? "<br>사업자 회원가입이 가능합니다."
                    : "<br>사업자 회원가입을 할 수 없습니다.";
            },
            error: function (err) {
                console.log(err.responseText);
            }
        });
    }

    // form 제출 이벤트 리스너 등록
    document.getElementById("companyForm").addEventListener("submit", function (e) {
        e.preventDefault(); // 기본 제출 막기

        const form = this;
        const password = document.getElementById("password").value;

        if (!validatePassword(password)) {
            alert("비밀번호는 8~16자이며, 영문자/숫자/특수문자를 모두 포함해야 합니다.");
            document.getElementById("password").focus();
            return;
        }

        if (!form.checkValidity()) {
            form.reportValidity(); // 브라우저 유효성 경고
            return;
        }

        businessRegi(); // 사업자 인증 → 성공 시 수동 submit
    });

    //  사업자 인증 후 제출 로직
    function businessRegi() {
        const form = document.getElementById("companyForm");

        //  폼 유효성 최종 체크
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        let num = document.getElementById('businessNo').value;

        if (num === '1234567890') {
            alert("사업자 인증에 성공했습니다. (테스트)");
            // form.submit();
            showLoadingAndSubmit(form);
            return;
        }

        const data = {"b_no": [num]};
        $.ajax({
            url: "/api/validate-business",
            type: "POST",
            data: JSON.stringify(data),
            dataType: "JSON",
            contentType: "application/json",
            success: function (result) {
                let valid = result.data[0]['b_stt_cd'];
                if (valid === '01') {
                    alert("사업자 인증에 성공했습니다.");
                    if (form.checkVisibility()) {

                        // form.submit();
                        if (form.checkVisibility()) {
                            showLoadingAndSubmit(form);
                        }
                    } else {
                        form.reportValidity();
                    }
                } else {
                    alert("사업자가 아닙니다.");
                }
            },
            error: function () {
                alert("인증 처리 중 에러 발생");
            }
        });
    }
</script>
<script>
    function showLoadingAndSubmit(form) {
        document.getElementById("loadingOverlay").style.display = "flex";
        form.submit();
    }
</script>
<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>
</body>
</html>