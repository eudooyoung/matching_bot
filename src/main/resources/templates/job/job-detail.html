<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>공고 상세보기</title>
    <link rel="stylesheet" th:href="@{/css/company-job.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">

    <style>
        .container {
            max-width: 900px;
            margin: 60px auto;
            padding: 20px;
        }

        .job-box {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 30px;
        }

        .job-title {
            font-size: 28px;
            font-weight: bold;
            color: #103254;
            margin-bottom: 10px;
        }

        .section {
            margin-bottom: 16px;
        }

        .section h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .section p {
            margin: 0;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header(role=${role})}"></div>

<div class="container">
    <!-- 유사도 비교용 키워드 (Spring에서 렌더링) -->
    <div id="similarity-data"
         th:data-job-skill="${job.skillKeywords}"
         th:data-resume-skill="${resume.skillKeywords}">
    </div>

    <div style="display: flex; align-items: center; gap: 8px;">
        <h2>
            공고 상세보기
            <span id="similarity-score" style="font-size: 1rem; color: #555; margin-left: 10px;">| 유사도 계산 중...</span>
        </h2>
        <div class="tooltip-wrapper">
            <button class="help-icon-button">?</button>
            <div class="tooltip-box">
                본인의 이력서를 선택해 현재 공고와 키워드<br>
                유사도를 계산하여 % 로 나타냅니다.
            </div>
        </div>
    </div>

    <div class="job-box">
        <div class="job-title" th:text="${job.title}">채용 제목</div>

        <div class="section">
            <h4>설명</h4>
            <p th:text="${job.description}">상세 설명</p>
        </div>

        <div class="section">
            <h4>근무지</h4>
            <p th:text="${job.address}">근무지 주소</p>
        </div>

        <div class="section">
            <h4>주요 업무</h4>
            <p th:text="${job.mainTask}">업무 내용</p>
        </div>

        <div class="section">
            <h4>필요 기술</h4>
            <p th:text="${job.requiredSkills}">필수 기술</p>
        </div>

        <div class="section">
            <h4>필요 성향</h4>
            <p th:text="${job.requiredTraits}">성향</p>
        </div>

        <div class="section">
            <h4>기술 키워드</h4>
            <p th:text="${job.skillKeywords}">기술 키워드</p>
        </div>

        <div class="section">
            <h4>성향 키워드</h4>
            <p th:text="${job.traitKeywords}">성향 키워드</p>
        </div>

        <div class="section">
            <h4>채용 기간</h4>
            <p th:text="${job.startDate} + ' ~ ' + ${job.endDate}">시작 ~ 종료일</p>
        </div>

        <div class="section">
            <h4>지원 이메일</h4>
            <p th:text="${job.enrollEmail}">example@domain.com</p>
        </div>

        <div class="section">
            <h4>안내 사항</h4>
            <p th:text="${job.notice}">지원 시 유의 사항</p>
        </div>

        <div id="tab-report" class="tab-content active">
            <div class="report-box">
                <div class="report-image-wrapper">
                    <a th:href="@{/attached/company/{id}(id=${companyId})}">
                        <img id="summaryImage"
                             th:attr="data-company-id=${companyId}"
                             src="/img/loading.jpg"
                             alt="기업 평가 요약"
                             loading="lazy"
                             class="report-image"/>
                    </a>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button type="button" class="nav-button" onclick="history.back()">돌아가기</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>
<script th:src="@{/js/auth/fetchWithAuth.js}"></script>
<script th:src="@{/js/chatbot/loadSummaryImage.js}"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const el = document.getElementById("similarity-data");
        const jobSkillRaw = el.dataset.jobSkill;
        const resumeSkillRaw = el.dataset.resumeSkill;
        console.log("jobSkillRaw", jobSkillRaw);
        console.log("resumeSkillRaw",resumeSkillRaw);
        // 로그인된 사용자에 resume가 없는 경우
        if (!resumeSkillRaw || resumeSkillRaw.trim() === "") {
            document.getElementById("similarity-score").textContent = " | 유사도: - (이력서 없음)";
            return;
        }

        // 문자열 → 배열 변환
        const jobSkills = jobSkillRaw.split(',').map(s => s.trim()).filter(Boolean);
        const resumeSkills = resumeSkillRaw.split(',').map(s => s.trim()).filter(Boolean);
        console.log("jobSkills:", jobSkills);
        console.log("resumeSkills:", resumeSkills);
        try {
            const response = await fetch("http://localhost:8081/calculate-similarity", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    job_skill_keys: jobSkills,
                    resume_skill_keys: resumeSkills
                })
            });

            if (response.ok) {
                const result = await response.json();
                const percent = Math.round(result.similarity * 100);
                document.getElementById("similarity-score").textContent = ` | 유사도: ${percent}%`;
            } else {
                document.getElementById("similarity-score").textContent = " | 유사도 불러오기 실패";
            }
        } catch (e) {
            console.error("유사도 계산 오류:", e);
            document.getElementById("similarity-score").textContent = " | 유사도 계산 실패";
        }
    });
</script>



</body>
</html>
