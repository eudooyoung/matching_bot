<div th:fragment="footer" th:attr="data-role=${role}">
  <footer class="footer">
    &copy; 2025 MatchingBot Inc. All rights reserved.
  </footer>

  <div id="chatbot-toggle" style="position: fixed; bottom: 20px; right: 20px; background-color: #103254; color: white; border-radius: 50%; width: 60px; height: 60px; font-size: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999;">
    ğŸ’¬
  </div>

  <div id="chatbot-modal" style="position: fixed; bottom: 90px; right: 20px; width: 350px; height: 500px; background-color: white; border: 1px solid #ccc; border-radius: 10px; display: none; flex-direction: column; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 9999;">
    <div style="background-color: #103254; color: white; padding: 10px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
      GPT ì±—ë´‡
      <button onclick="document.getElementById('chatbot-modal').style.display='none'" style="float:right; background:none; border:none; color:white;">âœ–</button>
    </div>
    <div id="chat-messages" style="flex:1; padding:10px; overflow-y:auto;"></div>
    <div style="display:flex; border-top:1px solid #ddd;">
      <input id="chat-input" type="text" style="flex:1; border:none; padding:10px;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      <button id="chat-send-button" style="background-color:#103254; color:white; border:none; padding:10px;">ì „ì†¡</button>
    </div>
  </div>

<!--  <script th:inline="javascript">-->
<!--    const userRole = /*[['${role}']]*/ "GUEST";-->
<!--  </script>-->

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggleBtn = document.getElementById("chatbot-toggle");
      const modal = document.getElementById("chatbot-modal");
      const chatMessages = document.getElementById("chat-messages");
      const sendBtn = document.getElementById("chat-send-button");
      const inputField = document.getElementById("chat-input");

      // âœ… userRoleì„ HTML ì†ì„±ì—ì„œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
      const footer = document.querySelector("div[th\\:fragment='footer'], div[data-role]");
      const userRole = footer?.dataset?.role || "GUEST";
      console.log("ğŸ‘¤ userRole =", userRole); // ë””ë²„ê¹… í™•ì¸ìš©

      toggleBtn.addEventListener("click", () => {
        const isOpening = modal.style.display === "none" || modal.style.display === "";
        if (isOpening) {
          modal.style.display = "flex";
          chatMessages.innerHTML = "";

          setTimeout(() => {
            switch (userRole) {
              case "GUEST":
                appendMessage("bot", "ë¹„íšŒì›ìœ¼ë¡œ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
                appendMessage("bot", "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: ê°œì¸ íšŒì›ê°€ì…, ê¸°ì—… íšŒì›ê°€ì…, ì»¤ë®¤ë‹ˆí‹°");
                break;
              case "COMPANY":
                appendMessage("bot", "ê¸°ì—…íšŒì›ìœ¼ë¡œ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
                appendMessage("bot", "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: ê¸°ì—…í˜ì´ì§€, ì±„ìš© ê³µê³  ê´€ë¦¬, ê´€ì‹¬ ì´ë ¥ì„œ ëª©ë¡, ê¸°ì—… ì •ë³´ ìˆ˜ì •, ì»¤ë®¤ë‹ˆí‹°");
                break;
              case "MEMBER":
                appendMessage("bot", "ì¼ë°˜íšŒì›ìœ¼ë¡œ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.");
                appendMessage("bot", "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: ì»¤ë®¤ë‹ˆí‹°, ë‚´ì£¼ë³€ì±„ìš©ê³µê³ , ë§ˆì´í˜ì´ì§€, ì´ë ¥ì„œ ê´€ë¦¬, ê´€ì‹¬ ê¸°ì—… ëª©ë¡, ê´€ì‹¬ ê³µê³  ëª©ë¡, ê°œì¸ ì •ë³´ ìˆ˜ì • ");
                break;
              default:
                appendMessage("bot", "ì—­í•  ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
          }, 50);
        } else {
          modal.style.display = "none";
        }
      });


      // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter ì…ë ¥
      sendBtn.addEventListener("click", sendMessage);
      inputField.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          sendMessage();
        }
      });

      // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
      async function sendMessage() {
        const message = inputField.value.trim();
        if (!message) return;

        appendMessage("user", message);
        inputField.value = "";

        const loadingMsg = document.createElement("div");
        loadingMsg.textContent = "ğŸ¤– ë‹µë³€ì„ ìƒì„± ì¤‘";
        loadingMsg.style.marginBottom = "8px";
        chatMessages.appendChild(loadingMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let dotCount = 0;
        const loadingInterval = setInterval(() => {
          dotCount = (dotCount + 1) % 4;
          loadingMsg.textContent = "ğŸ¤– ë‹µë³€ì„ ìƒì„± ì¤‘" + ".".repeat(dotCount);
        }, 500);

        try {
          const response = await fetch("/api/v1/chatbot/talk", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });

          const data = await response.json();
          clearInterval(loadingInterval);
          loadingMsg.remove();

          const reply = data.reply || "ì‘ë‹µ ì—†ìŒ";
          appendMessage("bot", reply);

          if (data.fullReply) {
            const moreBtn = createMoreButton(data.fullReply);
            chatMessages.appendChild(moreBtn);
          }

          if (data.redirect && data.url) {
            appendMessage("bot", "ì ì‹œ í›„ ì´ë™í•©ë‹ˆë‹¤.");
            setTimeout(() => window.location.href = data.url, 1500);
          }
        } catch (error) {
          clearInterval(loadingInterval);
          loadingMsg.textContent = "âŒ GPT í˜¸ì¶œ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì…ë‹ˆë‹¤.";
        }
      }

      // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
      function appendMessage(sender, text) {
        const msg = document.createElement("div");
        msg.innerHTML = (sender === "user" ? "ğŸ™‹ " : "ğŸ¤– ") + text.replace(/\n/g, "<br><br>");
        msg.style.marginBottom = "8px";
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ë”ë³´ê¸° ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
      function createMoreButton(fullText) {
        const button = document.createElement("button");
        button.textContent = "ë”ë³´ê¸°";
        button.style.marginTop = "6px";
        button.style.backgroundColor = "#f0f0f0";
        button.style.border = "none";
        button.style.padding = "5px 10px";
        button.style.cursor = "pointer";
        button.style.borderRadius = "6px";
        button.style.fontSize = "0.9rem";

        button.addEventListener("click", () => {
          appendMessage("bot", fullText);
          button.remove();
        });

        return button;
      }
    });
  </script>

</div>
