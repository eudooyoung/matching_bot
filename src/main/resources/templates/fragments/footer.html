<!-- templates/fragments/footer.html -->
<div th:fragment="footer">
  <footer class="footer">
    &copy; 2025 MatchingBot Inc. All rights reserved.
  </footer>

  <!-- âœ… ì±—ë´‡ ê³ ì • ë²„íŠ¼ -->
  <div id="chatbot-toggle" style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #103254;
      color: white;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;">
    ğŸ’¬
  </div>

  <!-- âœ… ì±—ë´‡ ëª¨ë‹¬ -->
  <div id="chatbot-modal" style="
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 350px;
      height: 500px;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 9999;">
    <div style="background-color: #103254; color: white; padding: 10px; border-top-left-radius: 10px; border-top-right-radius: 10px;">
      GPT ì±—ë´‡
      <button onclick="document.getElementById('chatbot-modal').style.display='none'" style="float:right; background:none; border:none; color:white;">âœ–</button>
    </div>
    <div id="chat-messages" style="flex:1; padding:10px; overflow-y:auto;"></div>
    <div style="display:flex; border-top:1px solid #ddd;">
      <input id="chat-input" type="text" style="flex:1; border:none; padding:10px;" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
      <button id="chat-send-button" style="background-color:#103254; color:white; border:none; padding:10px;">ì „ì†¡</button>
    </div>
  </div>

  <!-- âœ… JS ìŠ¤í¬ë¦½íŠ¸ -->
  <!-- âœ… ì‚¬ìš©ì roleì„ Thymeleafì—ì„œ JSë¡œ ì „ë‹¬ -->
  <!-- âœ… ì‚¬ìš©ì roleì„ Thymeleafì—ì„œ JSë¡œ ì „ë‹¬ -->
  <script th:inline="javascript">
    const userRole = /*[[${role} == null ? 'GUEST' : '${role}']]*/ "GUEST";
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggleBtn = document.getElementById("chatbot-toggle");
      const modal = document.getElementById("chatbot-modal");
      const sendBtn = document.getElementById("chat-send-button");

      // âœ… ì±—ë´‡ í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ
      if (toggleBtn && modal) {
        toggleBtn.addEventListener("click", () => {
          if (userRole === "GUEST") {
            const goLogin = confirm("ì±—ë´‡ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.\nì§€ê¸ˆ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (goLogin) {
              window.location.href = "/auth/login"; // ğŸ” ë¡œê·¸ì¸ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì •
            }
            return;
          }

          // ì±—ë´‡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
          modal.style.display = modal.style.display === "none" ? "flex" : "none";
        });
      }

      // âœ… ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
      async function sendMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message) return;

        appendMessage("user", message);
        input.value = "";

        const container = document.getElementById("chat-messages");

        // âœ… ë¡œë”© ë©”ì‹œì§€ + ì• ë‹ˆë©”ì´ì…˜
        const loadingMsg = document.createElement("div");
        loadingMsg.textContent = "ğŸ¤– ë‹µë³€ì„ ìƒì„± ì¤‘";
        loadingMsg.style.marginBottom = "8px";
        container.appendChild(loadingMsg);
        container.scrollTop = container.scrollHeight;

        let dotCount = 0;
        const loadingInterval = setInterval(() => {
          dotCount = (dotCount + 1) % 4;
          loadingMsg.textContent = "ğŸ¤– ë‹µë³€ì„ ìƒì„± ì¤‘" + ".".repeat(dotCount);
        }, 500);

        try {
          const response = await fetch("/api/v1/chatbot/talk", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });

          const data = await response.json();
          const reply = data.messages?.[1]?.content || data.reply || "GPT ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";

          clearInterval(loadingInterval);
          loadingMsg.textContent = "ğŸ¤– " + reply;
        } catch (error) {
          clearInterval(loadingInterval);
          loadingMsg.textContent = "âŒ GPT í˜¸ì¶œ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œì…ë‹ˆë‹¤.";
        }
      }

      function appendMessage(sender, text) {
        const container = document.getElementById("chat-messages");
        const msg = document.createElement("div");
        msg.textContent = (sender === "user" ? "ğŸ™‹ " : "ğŸ¤– ") + text;
        msg.style.marginBottom = "8px";
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
      }

      if (sendBtn) {
        sendBtn.addEventListener("click", sendMessage);
      }
    });
  </script>




</div>
